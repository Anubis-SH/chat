<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المدفعجية - قلاع الصحراء</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --steampunk-dark: #231a0d;
            --steampunk-panel: rgba(43, 30, 13, 0.9);
            --steampunk-border: #7a5c35;
            --steampunk-highlight: #f5deb3;
            --steampunk-text: #e8d8c2;
            --steampunk-button-bg: #8c6d46;
            --steampunk-button-border: #bca280;
            --steampunk-button-text: #1a1108;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--steampunk-dark);
            color: var(--steampunk-text);
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            -webkit-tap-highlight-color: transparent;
        }
        .cinzel { font-family: 'Cinzel', serif; }
        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s, transform 0.5s;
            opacity: 1;
            transform: scale(1);
            z-index: 20;
            padding: 1rem;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        .steampunk-bg {
            background-image: url('https://i.imgur.com/gKj2WpE.jpg');
            background-size: cover;
            background-position: center;
        }
        .steampunk-panel {
            background-color: var(--steampunk-panel);
            border: 4px solid var(--steampunk-border);
            box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        .steampunk-button {
            background-color: var(--steampunk-button-bg);
            border: 2px solid var(--steampunk-button-border);
            color: var(--steampunk-button-text);
            font-weight: bold;
            text-shadow: none;
            transition: all 0.2s;
        }
        .steampunk-button:hover {
            background-color: #a98965;
            box-shadow: 0 0 15px #f5deb3aa;
        }
        .steampunk-button:active { transform: translateY(2px); }
        .steampunk-button:disabled {
            background-color: #5c4b33;
            cursor: not-allowed;
        }
        .steampunk-input {
            background-color: #3d2c12;
            border: 2px solid var(--steampunk-border);
            color: var(--steampunk-text);
        }
        .steampunk-input:focus {
            outline: none;
            border-color: var(--steampunk-highlight);
            box-shadow: 0 0 10px #f5deb388;
        }
        @keyframes gear-spin {
            from { transform: rotate(0deg); } to { transform: rotate(360deg); }
        }
        .loader-gear {
            width: 80px;
            height: 80px;
            background-image: url('https://i.imgur.com/PsmgD1L.png');
            background-size: contain;
            animation: gear-spin 4s linear infinite;
        }
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: screen-shake 0.5s; }

        /* --- تصميم متجاوب لواجهة اللعبة --- */
        #game-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .game-hud {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            pointer-events: none; /* للسماح بالنقر من خلالها على الكانفاس */
        }
        .game-hud > * {
            pointer-events: auto; /* تفعيل النقر على العناصر الداخلية */
        }

        /* تخطيط الموبايل (افتراضي) */
        #players-hud-container {
            order: 1; /* اللاعبون في الأعلى */
            display: flex;
            justify-content: space-around;
            width: 100%;
            background: rgba(0,0,0,0.4);
            padding: 4px;
        }
        #controls-hud { order: 2; width: 100%; } /* التحكم في المنتصف */
        #exit-game-container { order: 3; position: absolute; top: 10px; right: 10px; } /* زر الخروج في زاوية الشاشة */

        /* تخطيط الشاشات الكبيرة (Desktop) */
        @media (min-width: 1024px) {
            .game-hud {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-end;
                padding: 1rem;
            }
            #players-hud-container {
                order: 1;
                flex-direction: column;
                width: 250px;
                background: transparent;
                padding: 0;
            }
            #controls-hud { order: 2; width: 50%; max-width: 600px; }
            #exit-game-container { order: 3; position: static; width: 250px; display: flex; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div id="loader-screen" class="screen bg-gray-900 bg-opacity-80 z-50">
        <div class="loader-gear"></div>
        <p class="cinzel text-2xl text-yellow-200 mt-4">DESERT ARTILLERY</p>
    </div>
    <div id="login-screen" class="screen steampunk-bg z-40 hidden">
        <div class="steampunk-panel w-full max-w-md p-8">
            <h1 class="cinzel text-4xl text-center text-yellow-200 mb-6">المدفعجية</h1>
            <form id="login-form">
                <input type="email" id="email" class="steampunk-input w-full p-3 rounded mb-4" placeholder="البريد الإلكتروني" required>
                <input type="password" id="password" class="steampunk-input w-full p-3 rounded mb-6" placeholder="كلمة المرور" required>
                <button type="submit" class="steampunk-button w-full p-3 rounded text-lg">دخـــول</button>
                <p id="login-error" class="text-red-400 text-center mt-4"></p>
            </form>
        </div>
    </div>
    <div id="lobby-screen" class="screen steampunk-bg z-30 hidden">
        <div class="steampunk-panel w-full max-w-4xl p-6 flex flex-col h-[90%] md:h-3/4">
            <div class="flex justify-between items-center mb-4">
                <h1 class="cinzel text-3xl md:text-4xl text-yellow-200">صالة اللعب</h1>
                <div class="text-left">
                    <p id="user-display" class="text-yellow-100"></p>
                    <button id="logout-button" class="text-red-400 hover:underline text-sm">تسجيل الخروج</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto border-4 border-[var(--steampunk-border)] p-4 rounded bg-[#3d2c12] min-h-0">
                <h2 class="cinzel text-2xl text-yellow-300 border-b-2 border-[var(--steampunk-border)] pb-2 mb-4">الغرف المتاحة</h2>
                <div id="rooms-list" class="space-y-3"></div>
            </div>
            <div class="mt-4">
                <button id="create-room-button" class="steampunk-button w-full p-3 rounded text-lg">أنشئ غرفة جديدة</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen z-20 hidden bg-black">
        <canvas id="game-canvas"></canvas>
        <div class="game-hud">
            <div id="players-hud-container"></div>
            <div id="controls-hud" class="steampunk-panel p-2 md:p-4">
                 <div class="w-full text-center mb-2">
                    <p id="turn-indicator" class="text-lg md:text-xl font-bold text-yellow-300"></p>
                    <p id="wind-indicator" class="text-sm md:text-lg font-bold text-cyan-300"></p>
                 </div>
                 <div class="flex items-center gap-2 md:gap-4 w-full text-sm md:text-base">
                     <span>الزاوية: <span id="angle-value">45</span>°</span>
                     <input id="angle-slider" type="range" min="0" max="180" value="45" class="w-full">
                 </div>
                 <div class="flex items-center gap-2 md:gap-4 w-full text-sm md:text-base">
                     <span>القوة: <span id="power-value">50</span></span>
                     <input id="power-slider" type="range" min="0" max="100" value="50" class="w-full">
                 </div>
                 <div class="flex justify-center items-center gap-4 mt-2">
                    <select id="weapon-select" class="steampunk-input rounded p-2 text-sm md:text-base">
                        <option value="normal">قذيفة عادية</option>
                        <option value="large">قذيفة كبيرة</option>
                        <option value="cluster">قذيفة عنقودية</option>
                    </select>
                    <button id="fire-button" class="steampunk-button px-6 py-2 md:px-10 md:py-3 rounded-lg text-lg md:text-2xl cinzel">إطــــلاق</button>
                 </div>
            </div>
            <div id="exit-game-container">
                <button id="exit-game-button" class="steampunk-button px-4 py-2 rounded">خروج</button>
            </div>
        </div>
    </div>

<script type="module">
    // --- إعدادات Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAeLDfHnZQ2VPzTXRzX4LG2CspnY09Pp6k",
      authDomain: "chat-11b02.firebaseapp.com",
      projectId: "chat-11b02",
      storageBucket: "chat-11b02.appspot.com",
      messagingSenderId: "837639744108",
      appId: "1:837639744108:web:99b97ffbf2b891a70c4649"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- عناصر الواجهة ---
    const screens = {
        loader: document.getElementById('loader-screen'),
        login: document.getElementById('login-screen'),
        lobby: document.getElementById('lobby-screen'),
        game: document.getElementById('game-screen'),
    };
    
    // --- حالة اللعبة العامة ---
    let currentUser = null, currentGameId = null;
    let gameUnsubscribe = null, roomsUnsubscribe = null;

    // --- إعدادات اللعبة ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let terrain = [], gameData = {}, particles = [];
    const GRAVITY = 0.15;

    // --- دوال التنقل بين الشاشات ---
    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }

    // --- منطق المصادقة وتسجيل الدخول/الخروج ---
    onAuthStateChanged(auth, user => {
        screens.loader.classList.add('hidden');
        if (user) {
            currentUser = { uid: user.uid, email: user.email, name: user.email.split('@')[0] };
            document.getElementById('user-display').textContent = `مرحباً، ${currentUser.name}`;
            showScreen('lobby');
            listenToRooms();
        } else {
            currentUser = null;
            if (roomsUnsubscribe) roomsUnsubscribe();
            if (gameUnsubscribe) gameUnsubscribe();
            showScreen('login');
        }
    });
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
        } catch (error) {
            document.getElementById('login-error').textContent = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
        }
    });
    document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

    // --- منطق اللوبي والغرف ---
    document.getElementById('create-room-button').addEventListener('click', async () => {
        const gameId = `game_${Date.now()}`;
        const newGame = {
            id: gameId,
            host: currentUser,
            players: [{...currentUser, hp: 100, color: '#FF5733'}],
            status: 'waiting',
            createdAt: new Date(),
            currentTurn: 0,
            wind: (Math.random() * 2 - 1) * 2.5,
        };
        await setDoc(doc(db, "games", gameId), newGame);
        joinGame(gameId);
    });

    function listenToRooms() {
        if (roomsUnsubscribe) roomsUnsubscribe();
        const q = query(collection(db, "games"), where("status", "==", "waiting"));
        roomsUnsubscribe = onSnapshot(q, (snapshot) => {
            const roomsList = document.getElementById('rooms-list');
            if (snapshot.empty) {
                roomsList.innerHTML = '<p class="text-gray-400 text-center">لا توجد غرف متاحة. قم بإنشاء واحدة!</p>';
                return;
            }
            roomsList.innerHTML = snapshot.docs.map(doc => {
                const room = doc.data();
                return `
                    <div class="steampunk-panel p-3 flex justify-between items-center bg-opacity-40">
                        <div>
                            <h3 class="text-lg text-yellow-200">غرفة ${room.host.name}</h3>
                            <p class="text-sm text-yellow-100">${room.players.length} / 4 لاعبين</p>
                        </div>
                        <button class="join-room-button steampunk-button px-4 py-2 rounded" data-id="${room.id}" ${room.players.length >= 4 ? 'disabled' : ''}>
                            ${room.players.length >= 4 ? 'ممتلئة' : 'انضم'}
                        </button>
                    </div>`;
            }).join('');
            document.querySelectorAll('.join-room-button').forEach(button => {
                button.onclick = () => joinGame(button.dataset.id);
            });
        });
    }

    async function joinGame(gameId) {
        if (!currentUser) return;
        const gameRef = doc(db, "games", gameId);
        const gameSnap = await getDoc(gameRef);
        if (gameSnap.exists()) {
            const game = gameSnap.data();
            const playerExists = game.players.some(p => p.uid === currentUser.uid);
            if (!playerExists && game.players.length < 4) {
                const playerColors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1'];
                await updateDoc(gameRef, { players: [...game.players, {...currentUser, hp: 100, color: playerColors[game.players.length]}] });
            }
            currentGameId = gameId;
            if (roomsUnsubscribe) roomsUnsubscribe();
            listenToGame(gameId);
        }
    }

    // --- منطق اللعبة الرئيسي ---
    function listenToGame(gameId) {
        showScreen('game');
        if (gameUnsubscribe) gameUnsubscribe();
        gameUnsubscribe = onSnapshot(doc(db, "games", gameId), (doc) => {
            if (!doc.exists()) { exitGame(); return; }
            const wasWaiting = gameData.status === 'waiting';
            gameData = doc.data();
            if (gameData.status === 'active' && wasWaiting) {
                if (gameData.host.uid === currentUser.uid && !gameData.terrain) {
                    generateTerrainAndPlacePlayers();
                    updateDoc(doc.ref, { terrain: terrain, players: gameData.players });
                    return;
                }
            }
            terrain = gameData.terrain;
            updateHUDs();
            if (gameData.lastShot) {
                animateProjectile(gameData.lastShot);
                if (currentUser.uid === gameData.host.uid) {
                    setTimeout(() => updateDoc(doc.ref, { lastShot: null }), 500);
                }
            }
        });
    }

    function generateTerrainAndPlacePlayers() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        terrain = [];
        let y = canvas.height * (Math.random() * 0.3 + 0.6);
        for (let i = 0; i < canvas.width; i++) {
            terrain.push(y);
            y += (Math.random() * 2 - 1) * 1.5;
            if (y > canvas.height * 0.9) y = canvas.height * 0.9;
            if (y < canvas.height * 0.4) y = canvas.height * 0.4;
        }
        const segment = canvas.width / (gameData.players.length + 1);
        gameData.players.forEach((player, i) => {
            player.x = segment * (i + 1);
            player.y = terrain[Math.floor(player.x)] - 10;
        });
    }

    document.getElementById('exit-game-button').addEventListener('click', async () => {
        if(gameData.host.uid === currentUser.uid) {
            await deleteDoc(doc(db, "games", currentGameId));
        }
        exitGame();
    });
    function exitGame() {
        if (gameUnsubscribe) gameUnsubscribe();
        gameUnsubscribe = null;
        currentGameId = null;
        showScreen('lobby');
        listenToRooms();
    }

    // --- الرسم والتحديث البصري ---
    function gameLoop() {
        draw();
        requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop); // بدء حلقة الرسم

    function draw() {
        if (!terrain || terrain.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const sky = ctx.createLinearGradient(0, 0, 0, canvas.height);
        sky.addColorStop(0, '#3a2a1a'); sky.addColorStop(0.6, '#8b5a33'); sky.addColorStop(1, '#4a331c');
        ctx.fillStyle = sky;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#b08a5d';
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        for(let i=0; i < terrain.length; i++) ctx.lineTo(i, terrain[i]);
        ctx.lineTo(canvas.width, canvas.height);
        ctx.closePath();
        ctx.fill();

        gameData.players.forEach(p => drawPlayer(p));
        particles.forEach((p, i) => {
            p.update();
            p.draw();
            if(p.life <= 0) particles.splice(i, 1);
        });
        drawAimingLine();
    }

    function drawPlayer(player) {
        if (player.hp <= 0) return;
        ctx.save();
        ctx.translate(player.x, player.y);
        // Base
        ctx.fillStyle = '#61412D';
        ctx.beginPath();
        ctx.moveTo(-20, 0); ctx.lineTo(20, 0); ctx.lineTo(15, 10); ctx.lineTo(-15, 10);
        ctx.closePath();
        ctx.fill();
        // Body
        ctx.fillStyle = player.color;
        ctx.fillRect(-15, -15, 30, 15);
        ctx.fillStyle = '#C0A080';
        ctx.fillRect(-17, -17, 34, 4);
        // Turret
        ctx.fillStyle = '#4A3223';
        ctx.beginPath();
        ctx.arc(0, -17, 8, 0, 2 * Math.PI);
        ctx.fill();
        // Cannon
        const angle = (180 - (gameData.currentTurn === gameData.players.findIndex(p=>p.uid===player.uid) ? document.getElementById('angle-slider').value : 45)) * Math.PI / 180;
        ctx.rotate(angle);
        ctx.fillStyle = '#333';
        ctx.fillRect(5, -2, 25, 4);
        ctx.restore();
    }
    
    function drawAimingLine() {
        if(!gameData.players) return;
        const currentPlayer = gameData.players[gameData.currentTurn];
        if(!currentPlayer || currentPlayer.uid !== currentUser.uid || gameData.status !== 'active') return;
        
        const angle = document.getElementById('angle-slider').value;
        const power = document.getElementById('power-slider').value;

        let angleRad = (180 - angle) * Math.PI / 180;
        let p = {
            x: currentPlayer.x + Math.cos(angleRad) * 30,
            y: currentPlayer.y - 17 + Math.sin(angleRad) * 30,
            vx: Math.cos(angleRad) * (power/5) + (gameData.wind || 0),
            vy: Math.sin(angleRad) * (power/5)
        };
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        for(let i=0; i<100; i++) {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += GRAVITY;
            if(i % 5 === 0) ctx.fillRect(p.x, p.y, 2, 2);
        }
    }

    // --- واجهة التحكم (HUD) ---
    function updateHUDs() {
        updatePlayersHUD();
        updateControlsHUD();
    }
    function updatePlayersHUD() {
        const hud = document.getElementById('players-hud-container');
        const isMobile = window.innerWidth < 1024;
        hud.innerHTML = gameData.players.map(p => `
            <div class="${isMobile ? 'text-center' : 'p-2 rounded mb-2'}" style="${!isMobile ? `background-color: ${p.color}55; border-right: 4px solid ${p.color}` : ''}">
                <p class="font-bold text-sm" style="color: ${p.color}; text-shadow: 1px 1px 2px #000;">${p.name} ${p.hp <= 0 ? '(دُمر)' : ''}</p>
                <div class="w-full bg-gray-700 rounded h-1.5 mt-1 mx-auto" style="max-width: 80px;">
                    <div class="bg-green-500 h-1.5 rounded" style="width: ${p.hp}%"></div>
                </div>
            </div>`).join('');
    }
    function updateControlsHUD() {
        const controls = document.getElementById('controls-hud');
        const turnIndicator = document.getElementById('turn-indicator');
        const windIndicator = document.getElementById('wind-indicator');
        if (gameData.status === 'waiting') {
            turnIndicator.textContent = "في انتظار اللاعبين...";
            controls.classList.add('hidden');
            if (gameData.host.uid === currentUser.uid && !document.getElementById('start-game-btn')) {
                const startBtn = document.createElement('button');
                startBtn.id = 'start-game-btn';
                startBtn.textContent = 'ابدأ اللعبة';
                startBtn.className = 'steampunk-button px-10 py-3 rounded-lg text-2xl cinzel mt-4';
                startBtn.onclick = () => updateDoc(doc(db, "games", currentGameId), { status: 'active' });
                document.getElementById('players-hud-container').insertAdjacentElement('afterend', startBtn);
            }
            return;
        }
        const startBtn = document.getElementById('start-game-btn');
        if(startBtn) startBtn.remove();
        
        controls.classList.remove('hidden');
        const currentPlayer = gameData.players[gameData.currentTurn];
        const isMyTurn = currentPlayer.uid === currentUser.uid;

        turnIndicator.textContent = isMyTurn ? "انه دورك!" : `دور: ${currentPlayer.name}`;
        let windText = `الرياح: ${Math.abs(gameData.wind).toFixed(1)} ${gameData.wind > 0.1 ? 'يمين' : gameData.wind < -0.1 ? 'يسار' : ''}`;
        windIndicator.textContent = windText;

        ['angle-slider', 'power-slider', 'weapon-select', 'fire-button'].forEach(id => {
            document.getElementById(id).disabled = !isMyTurn;
        });
    }

    ['angle-slider', 'power-slider'].forEach(id => {
        document.getElementById(id).addEventListener('input', e => {
            document.getElementById(`${id.split('-')[0]}-value`).textContent = e.target.value;
        });
    });

    // --- الفيزياء والتأثيرات ---
    document.getElementById('fire-button').addEventListener('click', () => {
        updateDoc(doc(db, "games", currentGameId), {
            lastShot: {
                angle: document.getElementById('angle-slider').value,
                power: document.getElementById('power-slider').value,
                weapon: document.getElementById('weapon-select').value,
                playerId: currentUser.uid,
            }
        });
    });

    function animateProjectile(shot) {
        const shooter = gameData.players.find(p => p.uid === shot.playerId);
        if (!shooter) return;
        let angleRad = (180 - shot.angle) * Math.PI / 180;
        let proj = {
            x: shooter.x + Math.cos(angleRad) * 30,
            y: shooter.y - 17 + Math.sin(angleRad) * 30,
            vx: Math.cos(angleRad) * (shot.power / 5) + (gameData.wind || 0),
            vy: Math.sin(angleRad) * (shot.power / 5),
            trail: []
        };
        const animLoop = () => {
            proj.x += proj.vx;
            proj.y += proj.vy;
            proj.vy += GRAVITY;
            proj.trail.push({x: proj.x, y: proj.y});
            if(proj.trail.length > 20) proj.trail.shift();

            // رسم مسار الدخان
            proj.trail.forEach((p, i) => {
                const opacity = i / proj.trail.length;
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.5})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, i/5, 0, 2 * Math.PI);
                ctx.fill();
            });

            if (proj.x < 0 || proj.x > canvas.width || (terrain[Math.floor(proj.x)] && proj.y > terrain[Math.floor(proj.x)])) {
                handleExplosion(proj.x, proj.y, shot.weapon);
            } else {
                requestAnimationFrame(animLoop);
            }
        };
        requestAnimationFrame(animLoop);
    }

    function createExplosion(x, y, radius) {
        // تأثير اهتزاز الشاشة
        canvas.classList.add('shake');
        setTimeout(() => canvas.classList.remove('shake'), 500);

        // إضافة جزيئات الانفجار
        for (let i = 0; i < radius * 2; i++) {
            particles.push(new Particle(x, y));
        }
        // TODO: إضافة مؤثر صوتي للانفجار هنا
    }
    
    class Particle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.vx = Math.random() * 6 - 3;
            this.vy = Math.random() * -8;
            this.life = Math.random() * 50 + 20;
            this.color = ['#ffc300', '#ff5733', '#c70039', '#900c3f'][Math.floor(Math.random() * 4)];
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.vy += GRAVITY / 2;
            this.life--;
        }
        draw() {
            ctx.fillStyle = `${this.color}${Math.round(this.life*5).toString(16)}`;
            ctx.fillRect(this.x, this.y, 3, 3);
        }
    }

    async function handleExplosion(x, y, weapon) {
        if (currentUser.uid !== gameData.host.uid) return;
        const weaponStats = {
            normal: { radius: 30, damage: 30 },
            large: { radius: 60, damage: 50 },
            cluster: { radius: 20, damage: 15, count: 5 }
        };
        const stats = weaponStats[weapon];
        
        const applyAndSync = (px, py, radius, damage) => {
            applyDamageAndDeform(px, py, radius, damage);
            updateDoc(doc(db, "games", currentGameId), { terrain, players, lastExplosion: {x:px, y:py, radius} });
        };
        
        if(weapon === 'cluster') {
            for(let i=0; i<stats.count; i++) {
                setTimeout(() => {
                    const clusterX = x + (Math.random() * 100 - 50);
                    const clusterY = y - (Math.random() * 50);
                    applyDamageAndDeform(clusterX, clusterY, stats.radius, stats.damage);
                }, i * 100);
            }
        } else {
             applyDamageAndDeform(x, y, stats.radius, stats.damage);
        }
        
        // المضيف فقط هو من يحدد الدور القادم بعد فترة قصيرة
        setTimeout(async () => {
            const alivePlayers = gameData.players.filter(p => p.hp > 0);
            let newStatus = alivePlayers.length <= 1 ? 'finished' : gameData.status;
            
            let nextTurn = (gameData.currentTurn + 1) % gameData.players.length;
            while(gameData.players[nextTurn].hp <= 0 && newStatus === 'active') {
                nextTurn = (nextTurn + 1) % gameData.players.length;
            }
            
            await updateDoc(doc(db, "games", currentGameId), {
                players: gameData.players,
                terrain: terrain,
                currentTurn: nextTurn,
                status: newStatus,
                wind: (Math.random() * 2 - 1) * 2.5
            });
            if(newStatus === 'finished') {
                setTimeout(() => alert(`انتهت اللعبة! الفائز: ${alivePlayers[0]?.name || 'لا أحد'}`), 1000);
            }
        }, weapon === 'cluster' ? 1000 : 500);
    }
    
    onSnapshot(doc(db, "games", "some_game_id"), (snapshot) => {
        if (snapshot.data()?.lastExplosion) {
            const {x, y, radius} = snapshot.data().lastExplosion;
            createExplosion(x, y, radius);
        }
    });

    function applyDamageAndDeform(x, y, radius, damage) {
        createExplosion(x,y,radius);
        const startX = Math.max(0, Math.floor(x - radius));
        const endX = Math.min(canvas.width, Math.floor(x + radius));
        for (let i = startX; i < endX; i++) {
            const dist = Math.abs(i - x);
            const deform = Math.sqrt(radius**2 - dist**2);
            if(terrain[i]) terrain[i] += deform;
        }
        gameData.players.forEach(p => {
            if (p.hp > 0) {
                const dist = Math.sqrt((p.x - x)**2 + (p.y - y)**2);
                if (dist < radius) {
                    p.hp = Math.max(0, p.hp - Math.floor(damage * (1 - dist / radius)));
                }
                if(terrain[Math.floor(p.x)]) p.y = terrain[Math.floor(p.x)] - 10;
            }
        });
    }

</script>
</body>
</html>
