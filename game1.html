<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>المتاهة المتغيرة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;          /* خلفية رئيسية */
      --panel:#0f172a;       /* لوحات */
      --muted:#94a3b8;       /* نص ثانوي */
      --accent:#22d3ee;      /* سماوي */
      --accent-2:#a78bfa;    /* بنفسجي فاتح */
      --danger:#ef4444;      /* أحمر */
      --success:#22c55e;     /* أخضر */
      --warning:#f59e0b;     /* أصفر */
    }
    html,body{height:100%}
    body{font-family:'Cairo',system-ui,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:radial-gradient(1200px 600px at 50% -10%,rgba(168,85,247,.15),transparent 60%), radial-gradient(800px 500px at 120% 10%,rgba(34,211,238,.12),transparent 60%), var(--bg); color:white}
    /* شبكة زخرفية */
    .gridfx{position:fixed;inset:0;pointer-events:none;background:
      linear-gradient(rgba(255,255,255,.04) 1px, transparent 1px) 0 0/32px 32px,
      linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px) 0 0/32px 32px;
      mask-image:radial-gradient(circle at 50% 20%, rgba(0,0,0,.75), transparent 70%)}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));backdrop-filter:saturate(1.2) blur(6px)}
    .btn{transition:transform .15s ease, filter .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.98)}

    /* Canvas بدقة عالية */
    canvas{background:#0b1224;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06)}

    /* حالة الاندفاع */
    .dash-active{box-shadow:0 0 0 3px rgba(167,139,250,.55),0 0 24px 6px rgba(167,139,250,.35) inset}

    /* شبّيك اتجاهات الموبايل */
    .dpad{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-template-rows:repeat(2,minmax(0,1fr));gap:.5rem}
    #moveUp{grid-area:1/2/2/3} #moveLeft{grid-area:2/3/3/4} #moveDown{grid-area:2/2/3/3} #moveRight{grid-area:2/1/3/2}

    /* شريط تبريد الاندفاع */
    .coolbar{height:4px;background:linear-gradient(90deg,var(--accent),var(--accent-2));opacity:.85}
  </style>
</head>
<body class="min-h-screen flex flex-col items-center">
  <div class="gridfx"></div>

  <!-- رأس بسيط -->
  <header class="w-full max-w-6xl px-4 pt-5 flex items-center justify-between">
    <h1 class="text-2xl sm:text-3xl font-black tracking-tight"><span class="text-cyan-400">المتاهة</span> المتغيرة</h1>
    <button id="openShopTop" class="btn px-4 py-2 rounded-xl glass border border-white/10 text-sm hover:brightness-110">المظاهر</button>
  </header>

  <!-- القائمة الرئيسية -->
  <section id="startMenu" class="fixed inset-0 z-40 flex items-center justify-center p-4">
    <div class="glass border border-white/10 rounded-3xl shadow-2xl w-full max-w-md p-6 text-center">
      <h2 class="text-4xl font-black mb-2 text-cyan-400">ابدأ اللعب</h2>
      <p class="text-slate-300 mb-6">اختر وضع اللعب</p>
      <div class="space-y-3 text-base">
        <button class="btn w-full rounded-2xl bg-blue-600 hover:brightness-110 py-3 font-bold" data-mode="classic">الوضع الكلاسيكي</button>
        <button class="btn w-full rounded-2xl bg-purple-600 hover:brightness-110 py-3 font-bold" data-mode="shifting-maze">المتاهة المتغيرة</button>
        <button class="btn w-full rounded-2xl bg-rose-600 hover:brightness-110 py-3 font-bold" data-mode="survival">وضع البقاء (3 وحوش)</button>
        <!-- زر جديد للخروج -->
        <button id="exitBtn" class="btn w-full rounded-2xl bg-slate-700 hover:brightness-110 py-3 font-bold">الخروج</button>
      </div>
      <div class="mt-6 flex items-center justify-between text-slate-400">
        <button id="howToBtn" class="hover:text-white">كيفية اللعب</button>
        <button id="openShop" class="hover:text-white">المظاهر</button>
      </div>
    </div>
  </section>

  <!-- شرح اللعب -->
  <section id="howTo" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="glass border border-white/10 rounded-3xl shadow-2xl w-full max-w-lg p-6 text-right">
      <h3 class="text-3xl font-bold text-cyan-400 text-center mb-4">كيفية اللعب</h3>
      <ul class="space-y-2 text-slate-200 list-disc pr-6">
        <li><b>الهدف:</b> ابحث عن المفتاح ثم اهرب إلى الخروج الأخضر.</li>
        <li><b>التحكم (كمبيوتر):</b> الأسهم أو WASD. الانتظار (Q). الاندفاع (مسطرة).</li>
        <li><b>التحكم (موبايل):</b> استخدم عصا الاتجاهات أسفل اللوحة.</li>
        <li><b>الاندفاع:</b> فعِّل الاندفاع ثم اختر اتجاهًا لتخطي حاجزين. به تبريد زمني.</li>
        <li><b>الشبح:</b> يطاردك ويُنذِر بمربع أحمر قبل وضع جدار مؤقت.</li>
      </ul>
      <button id="closeHowTo" class="btn w-full mt-5 rounded-2xl bg-blue-600 py-3 font-bold">فهمت!</button>
    </div>
  </section>

  <!-- واجهة اللعب -->
  <main id="gameUI" class="hidden w-full max-w-6xl px-4 pb-8 pt-4 flex flex-col gap-4">
    <!-- شريط معلومات -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 glass border border-white/10 rounded-2xl p-3 shadow-lg text-sm sm:text-base">
      <div><span class="block text-slate-400">الوضع</span><span id="modeDisplay" class="font-bold text-white text-lg">-</span></div>
      <div><span class="block text-slate-400">النقاط</span><span id="score" class="font-bold text-yellow-400 text-lg">0</span></div>
      <div><span class="block text-slate-400">المستوى/الزمن</span><span id="levelTimer" class="font-bold text-cyan-400 text-lg">1</span></div>
      <div><span class="block text-slate-400">المفتاح</span><span id="keyStatus" class="font-bold text-rose-400 text-lg">غير موجود</span></div>
    </div>

    <div class="flex flex-col lg:flex-row gap-4">
      <!-- الحاوية اليسرى: اللوحة -->
      <div class="flex-1 min-w-0">
        <div class="relative">
          <canvas id="mazeCanvas" class="w-full aspect-square"></canvas>
          <!-- إطار زخرفي -->
          <div class="pointer-events-none absolute inset-0 rounded-2xl ring-1 ring-white/10"></div>
        </div>
      </div>

      <!-- الحاوية اليمنى: أزرار -->
      <aside class="w-full lg:w-72 flex flex-col gap-4">
        <div class="glass border border-white/10 rounded-2xl p-3 flex flex-col gap-3">
          <div class="flex gap-3">
            <button id="waitBtn" class="btn flex-1 rounded-xl bg-slate-700 hover:brightness-110 py-3 font-bold">انتظر<span class="hidden md:inline"> (Q)</span></button>
          </div>
          <div>
            <button id="dashBtn" class="btn w-full rounded-xl bg-purple-600 hover:brightness-110 py-3 font-bold relative overflow-hidden">اندفاع <span class="hidden md:inline">(Space)</span>
              <div id="dashCooldownBar" class="coolbar absolute left-0 bottom-0" style="width:100%"></div>
            </button>
          </div>
        </div>

        <!-- تحكم موبايل -->
        <div class="glass border border-white/10 rounded-2xl p-4 md:hidden w-full max-w-xs self-center">
          <div class="dpad select-none">
            <button id="moveUp" class="btn rounded-xl bg-slate-800 py-3">▲</button>
            <button id="moveLeft" class="btn rounded-xl bg-slate-800 py-3">◀</button>
            <button id="moveDown" class="btn rounded-xl bg-slate-800 py-3">▼</button>
            <button id="moveRight" class="btn rounded-xl bg-slate-800 py-3">▶</button>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="backToMenuBtn" class="btn flex-1 rounded-xl glass border border-white/10 py-3">القائمة</button>
          <button id="restartBtn" class="btn flex-1 rounded-xl glass border border-white/10 py-3">إعادة</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- نافذة رسائل -->
  <section id="messageModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="glass border border-white/10 rounded-3xl shadow-2xl w-full max-w-md p-6 text-center">
      <h4 id="messageTitle" class="text-3xl font-bold mb-2"></h4>
      <p id="messageText" class="text-slate-200 mb-6"></p>
      <div class="space-y-3">
        <button id="primaryActionBtn" class="btn w-full rounded-2xl bg-emerald-600 hover:brightness-110 py-3 font-bold">المستوى التالي</button>
        <button id="toMenuBtn" class="btn w-full rounded-2xl bg-slate-700 hover:brightness-110 py-3 font-bold">القائمة الرئيسية</button>
      </div>
    </div>
  </section>

  <!-- متجر المظاهر -->
  <section id="skinsShop" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="glass border border-white/10 rounded-3xl shadow-2xl w-full max-w-4xl p-6 text-center flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-2">
        <h5 class="text-3xl font-bold text-cyan-400">متجر المظاهر</h5>
        <button id="closeShop" class="btn rounded-xl px-3 py-2 glass border border-white/10">إغلاق</button>
      </div>
      <p class="text-slate-300 mb-4">نقاطك الحالية: <span id="totalScoreDisplay" class="font-bold text-yellow-400">0</span></p>
      <div id="skinsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto pr-1"></div>
    </div>
  </section>

  <script>
  //==================== الثوابت العامة ====================
  const canvas = document.getElementById('mazeCanvas');
  const ctx = canvas.getContext('2d');
  const UI = {
    startMenu: document.getElementById('startMenu'), gameUI: document.getElementById('gameUI'),
    messageModal: document.getElementById('messageModal'), howTo: document.getElementById('howTo'),
    skinsShop: document.getElementById('skinsShop'),
    modeDisplay: document.getElementById('modeDisplay'), score: document.getElementById('score'),
    levelTimer: document.getElementById('levelTimer'), keyStatus: document.getElementById('keyStatus'),
    dashBtn: document.getElementById('dashBtn'), dashCooldownBar: document.getElementById('dashCooldownBar'),
    waitBtn: document.getElementById('waitBtn'),
    messageTitle: document.getElementById('messageTitle'), messageText: document.getElementById('messageText'),
    primaryActionBtn: document.getElementById('primaryActionBtn'), toMenuBtn: document.getElementById('toMenuBtn'),
    totalScoreDisplay: document.getElementById('totalScoreDisplay'), skinsContainer: document.getElementById('skinsContainer'),
    backToMenuBtn: document.getElementById('backToMenuBtn'), restartBtn: document.getElementById('restartBtn'),
    howToBtn: document.getElementById('howToBtn'), closeHowTo: document.getElementById('closeHowTo'),
    openShop: document.getElementById('openShop'), openShopTop: document.getElementById('openShopTop'), closeShop: document.getElementById('closeShop'),
    moveUp: document.getElementById('moveUp'), moveDown: document.getElementById('moveDown'), moveLeft: document.getElementById('moveLeft'), moveRight: document.getElementById('moveRight')
  };

  const TILE = { EMPTY:0, WALL:1, KEY:2, PORTAL:3, TRAP:4, TEMP_WALL:5 };

  //==================== رسومات矢 (بدون صور) ====================
  // مظهر اللاعب: وظائف رسم مت矢رة نظيفة
  const drawPlayerAvatar = {
    'أساسي': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      // حلقة خارجية
      g.fillStyle=p.c1; g.beginPath(); g.arc(0,0,s/2.6,0,Math.PI*2); g.fill();
      // بريق
      const grd=g.createRadialGradient(-s/6,-s/6,1,0,0,s/2.4); grd.addColorStop(0,'#fff8'); grd.addColorStop(1,p.c1); g.fillStyle=grd; g.beginPath(); g.arc(0,0,s/2.6,0,Math.PI*2); g.fill();
      // نواة
      g.fillStyle=p.c2; g.beginPath(); g.arc(0,0,s/6,0,Math.PI*2); g.fill();
      g.restore(); },
    'روبوت': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; roundRect(g,-s/3,-s/2.4,s*2/3,s*1.1,8,true);
      g.fillStyle=p.c2; roundRect(g,-s/4,-s/2.6,s/2,s/3.2,6,true);
      g.fillStyle=p.c3; g.beginPath(); g.arc(0,-s/3.6,s/12,0,Math.PI*2); g.fill(); g.restore(); },
    'سايكلوب': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; g.beginPath(); g.arc(0,0,s/2.4,0,Math.PI*2); g.fill();
      g.fillStyle=p.c2; g.beginPath(); g.arc(0,0,s/3.2,0,Math.PI*2); g.fill();
      g.fillStyle=p.c3; g.beginPath(); g.arc(0,0,s/8,0,Math.PI*2); g.fill(); g.restore(); },
    'نينجا': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; g.beginPath(); g.arc(0,0,s/2.5,0,Math.PI*2); g.fill();
      g.fillStyle=p.c2; roundRect(g,-s/2.6,-s/7,s/1.3,s/3.5,6,true);
      g.fillStyle=p.c3; g.beginPath(); g.arc(-s/7,-s/10,s/18,0,Math.PI*2); g.arc(s/7,-s/10,s/18,0,Math.PI*2); g.fill(); g.restore(); },
    'فارس': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; roundRect(g,-s/2.8,-s/2.2,s/1.4,s/1.1,10,true);
      g.fillStyle=p.c2; roundRect(g,-s/2.5,-s/5,s/1.25,s/5,6,true);
      g.fillStyle=p.c3; g.beginPath(); g.moveTo(0,-s/2.2); g.bezierCurveTo(s/3,-s/1.5,0,-s/1.2,0,-s/2.2); g.fill(); g.restore(); },
    'فضائي': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; g.beginPath(); g.ellipse(0,0,s/3,s/2.5,0,0,Math.PI*2); g.fill();
      g.fillStyle=p.c2; g.beginPath(); g.ellipse(-s/6,-s/8,s/10,s/6,Math.PI/4,0,Math.PI*2); g.fill(); g.beginPath(); g.ellipse(s/6,-s/8,s/10,s/6,-Math.PI/4,0,Math.PI*2); g.fill(); g.restore(); },
    'ساحر': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c2; g.beginPath(); g.arc(0,s/8,s/3.5,0,Math.PI*2); g.fill();
      g.fillStyle=p.c1; g.beginPath(); g.moveTo(-s/2.5,0); g.lineTo(s/2.5,0); g.lineTo(0,-s/2.2); g.closePath(); g.fill();
      g.fillStyle=p.c3; g.beginPath(); g.arc(0,s/8,s/10,0,Math.PI); g.fill(); g.restore(); },
    'جوهرة': (g,x,y,s,p)=>{ g.save(); g.translate(x,y);
      g.fillStyle=p.c1; g.beginPath(); g.moveTo(0,-s/2.3); g.lineTo(s/2.5,-s/7); g.lineTo(s/3,s/2.6); g.lineTo(-s/3,s/2.6); g.lineTo(-s/2.5,-s/7); g.closePath(); g.fill();
      g.globalAlpha=.45; g.fillStyle=p.c2; g.beginPath(); g.moveTo(0,-s/2.3); g.lineTo(-s/2.5,-s/7); g.lineTo(0,0); g.closePath(); g.fill(); g.globalAlpha=1; g.restore(); }
  };

  const SKINS = [
    { name:'أساسي', cost:0, draw:'أساسي', params:{c1:'#2dd4bf', c2:'#ffffff'} },
    { name:'أحمر ناري', cost:120, draw:'أساسي', params:{c1:'#ef4444', c2:'#fcd34d'} },
    { name:'أزرق عميق', cost:120, draw:'أساسي', params:{c1:'#3b82f6', c2:'#93c5fd'} },
    { name:'سايكلوب أخضر', cost:300, draw:'سايكلوب', params:{c1:'#16a34a', c2:'#ffffff', c3:'#000000'} },
    { name:'روبوت صدئ', cost:250, draw:'روبوت', params:{c1:'#a16207', c2:'#4a5568', c3:'#ef4444'} },
    { name:'روبوت لامع', cost:500, draw:'روبوت', params:{c1:'#9ca3af', c2:'#e5e7eb', c3:'#22d3ee'} },
    { name:'نينجا ليلي', cost:600, draw:'نينجا', params:{c1:'#111827', c2:'#dc2626', c3:'#ffffff'} },
    { name:'فارس فضي', cost:800, draw:'فارس', params:{c1:'#9ca3af', c2:'#1f2937', c3:'#ef4444'} },
    { name:'فضائي أخضر', cost:700, draw:'فضائي', params:{c1:'#4ade80', c2:'#000000'} },
    { name:'ساحر بنفسجي', cost:750, draw:'ساحر', params:{c1:'#7e22ce', c2:'#f3e8ff', c3:'#fef08a'} },
    { name:'جوهرة سماوية', cost:1200, draw:'جوهرة', params:{c1:'#22d3ee', c2:'#ffffff'} }
  ];

  // رسومات العناصر (مفتاح، بوابة، فخ، خروج، شبح)
  function drawKey(g,cx,cy,s){ g.save(); g.translate(cx,cy); g.strokeStyle='#fbbf24'; g.lineWidth=Math.max(2,s*.07); g.fillStyle='#f59e0b';
    g.beginPath(); g.arc(0,0,s*.22,0,Math.PI*2); g.fill(); g.stroke();
    g.beginPath(); g.moveTo(s*.18,0); g.lineTo(s*.45,0); g.lineTo(s*.45,s*.07); g.moveTo(s*.36,0); g.lineTo(s*.36,-s*.07); g.stroke(); g.restore(); }
  function drawPortal(g,cx,cy,s){ g.save(); g.translate(cx,cy); const r=s*.4; const grd=g.createConicGradient(0,0,0); grd.addColorStop(0,'#a78bfa'); grd.addColorStop(.5,'#22d3ee'); grd.addColorStop(1,'#a78bfa'); g.strokeStyle=grd; g.lineWidth=Math.max(2,s*.08); g.beginPath(); g.arc(0,0,r,0,Math.PI*2); g.stroke(); g.globalAlpha=.2; g.fillStyle='#22d3ee'; g.beginPath(); g.arc(0,0,r*.8,0,Math.PI*2); g.fill(); g.restore(); }
  function drawTrap(g,cx,cy,s){ g.save(); g.translate(cx,cy); g.fillStyle='#ef4444'; g.beginPath(); g.moveTo(-s*.4,s*.35); g.lineTo(0,-s*.35); g.lineTo(s*.4,s*.35); g.closePath(); g.fill(); g.restore(); }
  function drawExit(g,x,y,size,hasKey){ g.save(); g.translate(x,y); g.fillStyle = hasKey? 'rgba(34,197,94,.85)':'rgba(99,102,241,.35)'; g.fillRect(0,0,size,size); if(!hasKey){ g.strokeStyle='#e2e8f0'; g.lineWidth=Math.max(2,size*.07); g.beginPath(); g.moveTo(size*.2,size*.5); g.lineTo(size*.8,size*.5); g.moveTo(size*.2,size*.35); g.lineTo(size*.2,size*.65); g.moveTo(size*.8,size*.35); g.lineTo(size*.8,size*.65); g.stroke(); } g.restore(); }
  function drawGhost(g,cx,cy,s){ g.save(); g.translate(cx,cy); g.fillStyle='#cbd5e1'; roundRect(g,-s*.32,-s*.3,s*.64,s*.46,10,true); g.beginPath(); g.moveTo(-s*.32,s*.16); for(let i=0;i<4;i++){ const x=-s*.32 + i*(s*.64/3); const mid=x + s*.64/6; const nx=x + s*.64/3; g.quadraticCurveTo(mid,s*.34,nx,s*.16);} g.closePath(); g.fill(); g.fillStyle='#0f172a'; g.beginPath(); g.arc(-s*.12,-s*.08,s*.06,0,Math.PI*2); g.arc(s*.12,-s*.08,s*.06,0,Math.PI*2); g.fill(); g.restore(); }
  function drawTelegraph(g,x,y,size){ g.save(); g.globalAlpha = (Math.sin(Date.now()/150)+1)/4 + .5; g.fillStyle='rgba(239,68,68,.85)'; g.fillRect(x,y,size,size); g.restore(); }

  function roundRect(g,x,y,w,h,r,fill){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); if(fill) g.fill(); }

  //==================== حالة اللعبة ====================
  let game = {};

  function baseState(){
    return {
      mode:'classic', level:1, size:8, cell:0, maze:[],
      player:{x:0,y:0,hasKey:false}, exit:{x:7,y:7},
      ghosts:[], entities:[], tempWalls:[], score:0, time:0,
      timer:null, over:false, dashReady:true, dashCD:5000, dashActive:false,
      skin: loadData().skin, steps:0
    }
  }

  //==================== تخزين محلي ====================
  function loadData(){ try{ return JSON.parse(localStorage.getItem('mazeProV1')) || {score:0, unlocked:[SKINS[0].name], skin:SKINS[0].name}; }catch{ return {score:0, unlocked:[SKINS[0].name], skin:SKINS[0].name}; } }
  function saveData(patch){ const d=loadData(); localStorage.setItem('mazeProV1', JSON.stringify({...d,...patch})); }
  function addScore(v){ const d=loadData(); const s=Math.max(0,(d.score||0)+v); saveData({score:s}); return s; }

  //==================== تشغيل اللعبة ====================
  function startGame(mode){ if(!localStorage.getItem('mazeProSeenHowTo')){ toggleHowTo(true); localStorage.setItem('mazeProSeenHowTo','1'); }
    game = baseState(); game.mode = mode; if(mode==='survival'){ game.size=14; game.exit=null; } else if(mode==='shifting-maze'){ game.size=10; }
    UI.startMenu.classList.add('hidden'); UI.gameUI.classList.remove('hidden'); UI.messageModal.classList.add('hidden');
    setupLevel(); }

  function setupLevel(){ game.over=false; game.player={x:0,y:0,hasKey:false}; game.exit = game.mode!=='survival'? {x:game.size-1, y:game.size-1}: null; game.tempWalls=[]; game.ghosts=[];
    if(game.mode==='survival'){ game.ghosts.push({x:game.size-1,y:game.size-1,cool:3,tele:null}); game.ghosts.push({x:0,y:game.size-1,cool:5,tele:null}); game.ghosts.push({x:game.size-1,y:0,cool:4,tele:null}); }
    else{ game.ghosts.push({x:game.size-1,y:game.size-1,cool:3,tele:null}); }
    generateMaze(); placeEntities(); fitCanvas(); if(game.mode==='survival'){ game.time=0; if(game.timer) clearInterval(game.timer); game.timer=setInterval(()=>{ game.time++; updateUI(); },1000); }
    updateUI(); draw(); }

  function nextLevel(){ UI.messageModal.classList.add('hidden'); addScore(game.score); game.level++; if(game.level%2===1) game.size=Math.min(20, game.size+2); game.score=0; game.steps=0; setupLevel(); }

  function endGame(title,msg){ game.over=true; if(game.timer) clearInterval(game.timer); addScore(game.score); UI.messageTitle.textContent=title; UI.messageText.textContent= msg + ` | نقاطك النهائية: ${game.score}`; UI.primaryActionBtn.textContent='حاول مجدداً'; UI.primaryActionBtn.onclick=()=>startGame(game.mode); UI.messageModal.classList.remove('hidden'); }

  //==================== المتاهة والمنطق ====================
  function generateMaze(){
    const N=game.size; const maze = Array.from({length:N},()=>Array.from({length:N},()=>({walls:[true,true,true,true],v:false})));
    const st=[{x:0,y:0}]; maze[0][0].v=true; while(st.length){ const c=st[st.length-1]; const nb=[];
      if(c.y>0 && !maze[c.y-1][c.x].v) nb.push({x:c.x,y:c.y-1});
      if(c.x<N-1 && !maze[c.y][c.x+1].v) nb.push({x:c.x+1,y:c.y});
      if(c.y<N-1 && !maze[c.y+1][c.x].v) nb.push({x:c.x,y:c.y+1});
      if(c.x>0 && !maze[c.y][c.x-1].v) nb.push({x:c.x-1,y:c.y});
      if(nb.length){ const nx=nb[Math.floor(Math.random()*nb.length)];
        if(nx.y<c.y){ maze[c.y][c.x].walls[0]=false; maze[nx.y][nx.x].walls[2]=false; }
        if(nx.x>c.x){ maze[c.y][c.x].walls[1]=false; maze[nx.y][nx.x].walls[3]=false; }
        if(nx.y>c.y){ maze[c.y][c.x].walls[2]=false; maze[nx.y][nx.x].walls[0]=false; }
        if(nx.x<c.x){ maze[c.y][c.x].walls[3]=false; maze[nx.y][nx.x].walls[1]=false; }
        maze[nx.y][nx.x].v=true; st.push(nx);
      } else st.pop(); }
    game.maze=maze;
  }

  function placeEntities(){ game.entities=[]; const count=Math.floor(game.size/3); if(game.mode!=='survival') addEntity(TILE.KEY); for(let i=0;i<count;i++){ addEntity(TILE.PORTAL); addEntity(TILE.TRAP); } }
  function addEntity(type){ let x,y; do{ x=Math.floor(Math.random()*game.size); y=Math.floor(Math.random()*game.size); }while((x<2&&y<2) || (game.exit && x===game.exit.x && y===game.exit.y) || game.entities.some(e=>e.x===x&&e.y===y)); game.entities.push({x,y,type}); }

  function canMove(x,y,dx,dy,forPath=false){ const cell=game.maze[y][x]; if(dx===1 && cell.walls[1]) return false; if(dx===-1 && cell.walls[3]) return false; if(dy===1 && cell.walls[2]) return false; if(dy===-1 && cell.walls[0]) return false; if(!forPath){ const nx=x+dx, ny=y+dy; if(game.tempWalls.some(w=>w.x===nx&&w.y===ny)) return false; } return true; }
  const isTempWall=(x,y)=> game.tempWalls.some(w=>w.x===x&&w.y===y);

  function handleTurn(dx,dy){ if(game.over) return; if(game.dashActive){ doDash(dx,dy); return; } const nx=game.player.x+dx, ny=game.player.y+dy; if(nx<0 || ny<0 || nx>=game.size || ny>=game.size) return; if(canMove(game.player.x,game.player.y,dx,dy)){ game.player.x=nx; game.player.y=ny; onCell(); endTurn(); vibrate(10); } }
  function onCell(){ const i=game.entities.findIndex(e=>e.x===game.player.x && e.y===game.player.y); if(i===-1) return; const e=game.entities[i]; if(e.type===TILE.KEY){ game.player.hasKey=true; game.entities.splice(i,1); }
    else if(e.type===TILE.TRAP){ game.player.x=0; game.player.y=0; }
    else if(e.type===TILE.PORTAL){ let np; do{ np={x:Math.floor(Math.random()*game.size),y:Math.floor(Math.random()*game.size)} }while(np.x===game.player.x&&np.y===game.player.y); game.player=np; }
  }
  function endTurn(){ game.steps++; if(game.mode==='shifting-maze' && game.steps>=5){ game.steps=0; generateMaze(); }
    moveGhosts(); if(game.mode==='survival'){ game.score=game.time; } updateUI(); draw(); checkStatus(); }

  function checkStatus(){ if(game.exit && game.player.x===game.exit.x && game.player.y===game.exit.y){ if(!game.player.hasKey) return; game.over=true; const add=100+(game.size*10); game.score+=add; UI.messageTitle.textContent='أحسنت!'; UI.messageText.textContent=`نقاطك: ${game.score}`; UI.primaryActionBtn.textContent='المستوى التالي'; UI.primaryActionBtn.onclick=nextLevel; UI.messageModal.classList.remove('hidden'); }
    if(game.ghosts.some(g=>g.x===game.player.x && g.y===game.player.y)){ if(game.mode==='survival') endGame('أمسك بك الشبح!',`لقد صمدت ${game.time} ثانية.`); else endGame('أمسك بك الشبح!','حظًا أوفر.'); } }

  function moveGhosts(){ game.ghosts.forEach(g=>moveGhost(g)); }
  function moveGhost(g){ if(g.tele){ const {x,y}=g.tele; if(!isTempWall(x,y)) game.tempWalls.push({x,y,type:TILE.TEMP_WALL,l:5}); g.tele=null; g.cool=3; }
    game.tempWalls.forEach((w,i)=>{ w.l--; if(w.l<=0) game.tempWalls.splice(i,1); });
    g.cool--; if(g.cool<=0) planTrap(g); else chase(g); }
  function chase(g){ const P=game.player; const path=findPath({x:g.x,y:g.y},{x:P.x,y:P.y}); if(path && path.length>1){ g.x=path[1].x; g.y=path[1].y; } }
  function planTrap(g){ const P=game.player; const n=[]; [{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}].forEach(({dx,dy})=>{ if(canMove(P.x,P.y,dx,dy)) n.push({x:P.x+dx,y:P.y+dy}); }); if(n.length){ const pick=n[Math.floor(Math.random()*n.length)]; if(pick && !isTempWall(pick.x,pick.y)) g.tele=pick; } else g.cool=1; }
  function findPath(s,e){ const q=[[s]], vis=new Set([`${s.x},${s.y}`]); while(q.length){ const p=q.shift(); const c=p[p.length-1]; if(c.x===e.x && c.y===e.y) return p; [{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}].forEach(({dx,dy})=>{ if(canMove(c.x,c.y,dx,dy,true)){ const nx={x:c.x+dx,y:c.y+dy}; const k=`${nx.x},${nx.y}`; if(!vis.has(k)){ vis.add(k); q.push([...p,nx]); } } }); } return null; }

  //==================== اندفاع ====================
  function activateDash(){ if(!game.dashReady || game.over) return; game.dashActive=true; canvas.classList.add('dash-active'); }
  function doDash(dx,dy){ const tx=game.player.x + dx*2, ty=game.player.y + dy*2; if(tx>=0 && ty>=0 && tx<game.size && ty<game.size){ game.player.x=tx; game.player.y=ty; game.dashReady=false; cooldownDash(); onCell(); endTurn(); vibrate(15); } game.dashActive=false; canvas.classList.remove('dash-active'); }
  function cooldownDash(){ UI.dashBtn.disabled=true; UI.dashCooldownBar.style.width='0%'; let rem=game.dashCD; const it=setInterval(()=>{ rem-=100; UI.dashCooldownBar.style.width=`${100-(rem/game.dashCD*100)}%`; if(rem<=0){ clearInterval(it); game.dashReady=true; UI.dashBtn.disabled=false; } },100); }

  //==================== رسم المشهد ====================
  function draw(){ if(!game || !game.maze.length) return; const N=game.size, S=game.cell; ctx.clearRect(0,0,canvas.width,canvas.height);
    // خطوط المتاهة
    ctx.strokeStyle='#475569'; ctx.lineWidth=Math.max(2, S*0.06);
    for(let y=0;y<N;y++) for(let x=0;x<N;x++){ const c=game.maze[y][x]; const x0=x*S, y0=y*S;
      if(c.walls[0]){ ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0+S,y0); ctx.stroke(); }
      if(c.walls[1]){ ctx.beginPath(); ctx.moveTo(x0+S,y0); ctx.lineTo(x0+S,y0+S); ctx.stroke(); }
    }
    // الحد السفلي والأيسر
    ctx.beginPath(); ctx.moveTo(0,N*S); ctx.lineTo(N*S,N*S); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,N*S); ctx.stroke();

    // إنذارات الأشباح
    game.ghosts.forEach(g=>{ if(g.tele){ drawTelegraph(ctx, g.tele.x*S, g.tele.y*S, S); } });

    // العناصر
    game.entities.forEach(({x,y,type})=>{ const cx=x*S+S/2, cy=y*S+S/2; if(type===TILE.KEY) drawKey(ctx,cx,cy,S); if(type===TILE.PORTAL) drawPortal(ctx,cx,cy,S); if(type===TILE.TRAP) drawTrap(ctx,cx,cy,S); });

    // جدران مؤقتة
    game.tempWalls.forEach(({x,y,l})=>{ ctx.fillStyle = `rgba(100,116,139,${0.5 + l*0.1})`; ctx.fillRect(x*S,y*S,S,S); });

    // الخروج
    if(game.exit){ drawExit(ctx, game.exit.x*S, game.exit.y*S, S, game.player.hasKey); }

    // الأشباح
    game.ghosts.forEach(g=>{ const gx=g.x*S+S/2, gy=g.y*S+S/2; drawGhost(ctx,gx,gy,S); });

    // اللاعب
    const skin=SKINS.find(s=>s.name===game.skin); if(skin){ const px=game.player.x*S+S/2, py=game.player.y*S+S/2; drawPlayerAvatar[skin.draw](ctx,px,py,S,skin.params); }
  }

  //==================== واجهة المستخدم ====================
  function updateUI(){ const map={classic:'كلاسيكي', survival:'بقاء', 'shifting-maze':'متاهة متغيرة'}; UI.modeDisplay.textContent=map[game.mode]; if(game.mode==='survival'){ UI.score.textContent='-'; UI.levelTimer.textContent=`${Math.floor(game.time/60)}:${(game.time%60).toString().padStart(2,'0')}`; UI.keyStatus.textContent='-'; UI.keyStatus.className='font-bold text-lg text-slate-300'; } else { UI.score.textContent=game.score; UI.levelTimer.textContent=game.level; UI.keyStatus.textContent = game.player.hasKey ? 'موجود' : 'غير موجود'; UI.keyStatus.className = `font-bold text-lg ${game.player.hasKey? 'text-emerald-400':'text-rose-400'}`; } }

  function toggleHowTo(show){ UI.howTo.classList.toggle('hidden', !show); }
  function toMenu(){ UI.gameUI.classList.add('hidden'); UI.messageModal.classList.add('hidden'); UI.startMenu.classList.remove('hidden'); if(game.timer) clearInterval(game.timer); }

  //==================== متجر المظاهر ====================
  function openShop(){ const d=loadData(); UI.totalScoreDisplay.textContent=d.score; UI.skinsContainer.innerHTML=''; SKINS.forEach(skin=>{ const unlocked = d.unlocked.includes(skin.name); const afford = d.score >= skin.cost; const selected = d.skin === skin.name; const card=document.createElement('button'); card.className=`text-left rounded-2xl p-3 border transition ${selected? 'border-yellow-400 bg-yellow-400/10':'border-white/10 glass hover:brightness-110'}`;
      const row=document.createElement('div'); row.className='flex items-center gap-3';
      const prev=document.createElement('canvas'); prev.width=64; prev.height=64; const pc=prev.getContext('2d'); drawPlayerAvatar[skin.draw](pc,32,32,50,skin.params);
      const meta=document.createElement('div'); meta.className='text-sm'; meta.innerHTML = unlocked ? `<div class="font-bold">${skin.name}</div>` : `<div class="font-bold text-slate-300">${skin.name}</div><div class="${afford?'text-yellow-400':'text-rose-400'}">${skin.cost} نقطة</div>`;
      row.appendChild(prev); row.appendChild(meta); card.appendChild(row);
      if(unlocked){ card.onclick=()=>{ game.skin=skin.name; saveData({skin:skin.name}); openShop(); draw(); }; }
      else if(afford){ card.onclick=()=>{ addScore(-skin.cost); const u=[...d.unlocked, skin.name]; saveData({skin:skin.name, unlocked:u}); game.skin=skin.name; openShop(); draw(); }; }
      else { card.disabled=true; card.classList.add('opacity-60','cursor-not-allowed'); }
      UI.skinsContainer.appendChild(card); }); UI.skinsShop.classList.remove('hidden'); }
  function closeShop(){ UI.skinsShop.classList.add('hidden'); }

  //==================== حجم اللوحة (مع DPR) ====================
  function fitCanvas(){ const container=canvas.parentElement; if(!container) return; const maxH= Math.min(window.innerHeight*0.75, 720); const size = Math.min(container.clientWidth, maxH); const N=game.size; game.cell = size / N; // CSS حجم مرئي
    const dpr = Math.max(1, window.devicePixelRatio || 1); canvas.style.width = `${size}px`; canvas.style.height = `${size}px`; canvas.width = Math.round(size * dpr); canvas.height = Math.round(size * dpr); ctx.setTransform(dpr,0,0,dpr,0,0); draw(); }

  //==================== إدخال المستخدم ====================
  function vibrate(ms){ if('vibrate' in navigator) try{ navigator.vibrate(ms);}catch{} }
  window.addEventListener('resize', fitCanvas);
  document.addEventListener('keydown', (e)=>{ if(UI.gameUI.classList.contains('hidden')) return; const k=e.key.toLowerCase(); if(['arrowup','w'].includes(k)) handleTurn(0,-1); else if(['arrowdown','s'].includes(k)) handleTurn(0,1); else if(['arrowleft','a'].includes(k)) handleTurn(-1,0); else if(['arrowright','d'].includes(k)) handleTurn(1,0); else if(k===' '){ e.preventDefault(); activateDash(); } else if(k==='q') handleTurn(0,0); });
  UI.dashBtn.addEventListener('click', activateDash); UI.waitBtn.addEventListener('click', ()=>handleTurn(0,0));
  UI.moveUp.addEventListener('click', ()=>handleTurn(0,-1)); UI.moveDown.addEventListener('click', ()=>handleTurn(0,1)); UI.moveLeft.addEventListener('click', ()=>handleTurn(-1,0)); UI.moveRight.addEventListener('click', ()=>handleTurn(1,0));

  // أزرار عامة
  UI.backToMenuBtn.addEventListener('click', toMenu);
  UI.restartBtn.addEventListener('click', ()=>startGame(game.mode));
  UI.toMenuBtn.addEventListener('click', toMenu);
  document.querySelectorAll('#startMenu [data-mode]').forEach(btn=> btn.addEventListener('click', ()=> startGame(btn.dataset.mode)) );
  UI.howToBtn.addEventListener('click', ()=>toggleHowTo(true)); UI.closeHowTo.addEventListener('click', ()=>toggleHowTo(false));
  UI.openShop.addEventListener('click', openShop); UI.openShopTop.addEventListener('click', openShop); UI.closeShop.addEventListener('click', closeShop);

  // زر الخروج الجديد -> يؤدي إلى chat.html
  const exitBtn = document.getElementById('exitBtn');
  if(exitBtn){
    exitBtn.addEventListener('click', ()=> {
      // نقل المستخدم إلى صفحة الدردشة
      window.location.href = 'chat.html';
    });
  }

  // تفعيل الاندفاع واتجاهه
  function onDirectionalDash(dx,dy){ if(game.dashActive) doDash(dx,dy); }
  // لمس طويل على زر الاندفاع؟ (اختياري)

  // بدء أولي
  document.addEventListener('DOMContentLoaded', ()=>{ game = baseState(); game.skin = loadData().skin; toMenu(); fitCanvas(); });
  </script>
</body>
</html>
